<form class="c-orderForm" [formGroup]="orderForm">
  <div class="c-orderForm__header">
    <p class="c-orderForm__title">{{'–®–≤–∏–¥–∫–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è' | translate}}</p>

    <span class="c-orderForm__close" matDialogClose>
      <mat-icon>close</mat-icon>
    </span>
  </div>
  <div class="c-orderForm__body">
    <mat-form-field appearance="fill" class="c-cityDialog__formField">
      <mat-label>{{'–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ' | translate}}</mat-label>
      <mat-select
        disableOptionCentering
        formControlName="city"
        role="listbox"
        (valueChange)="getEstablishments($event)"
        [disabled]="!isCitiesLoaded">
        <ng-container *ngIf="areasWithRegions.length; else citiesEmpty">
          <mat-option role="listitem">
            <ngx-mat-select-search
              [formControl]="areaFilterCtrl"
              [placeholderLabel]="'–ó–Ω–∞–π—Ç–∏ –º—ñ—Å—Ç–æ' | translate"
              noEntriesFoundLabel="{{'–ú–∏ –Ω–µ –∑–Ω–∞–π—à–ª–∏ —Ç–∞–∫–µ –º—ñ—Å—Ç–æ' | translate}} üòû"
              ariaLabel="–ù–∞–π—Ç–∏ —Å–≤–æ–π –≥–æ—Ä–æ–¥"></ngx-mat-select-search>
          </mat-option>
          <mat-optgroup *ngFor="let area of filteredArea | async"
                        [label]="area.name_en | getLocalizationCityKey | translate">
            <mat-option *ngFor="let region of area.regions" [value]="region.name_en" role="listitem">
              {{region.name_en | getLocalizationCityKey | translate}}
            </mat-option>
          </mat-optgroup>
        </ng-container>
        <ng-template #citiesEmpty>
          <p class="c-cityDialog__text c-cityDialog__text--empty">
            {{'–ó–∞—Ä–∞–∑ –Ω–µ–º–∞—î –º—ñ—Å—Ç —ñ–∑ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–º–∏ –∑–∞–∫–ª–∞–¥–∞–º–∏.' | translate}}üòû
          </p>
        </ng-template>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill" class="c-cityDialog__formField">
      <mat-label>{{'–í–∏–±–µ—Ä—ñ—Ç—å –∑–∞–∫–ª–∞–¥' | translate}}</mat-label>
      <mat-select
        disableOptionCentering
        formControlName="establishment"
        role="listbox"
        (valueChange)="getCategoriesWithProducts($event, true)"
        [disabled]="!networksSub.closed || establishments.length === 0">
        <ng-container *ngIf="establishments.length; else establishmentsEmpty">
          <mat-option role="listitem">
            <ngx-mat-select-search
              [formControl]="shopsFilter"
              [placeholderLabel]="'–ó–Ω–∞–π—Ç–∏ –∑–∞–∫–ª–∞–¥' | translate"
              noEntriesFoundLabel="{{'–ú–∏ –Ω–µ –∑–Ω–∞–π—à–ª–∏ —Ç–∞–∫–∏–π –∑–∞–∫–ª–∞–¥' | translate}} üòû"
              ariaLabel="–ó–Ω–∞–π—Ç–∏ –∫–∞–≤'—è—Ä–Ω—é"></ngx-mat-select-search>
          </mat-option>
          <mat-option *ngFor="let establishment of establishments | search:shopsFilter.value:'slug'"
                      [value]="establishment.slug" role="listitem">
            <img [src]="API_URL + establishment.avatar" [alt]="establishment.name" class="c-cityDialog__formFieldImg">
            <span class="c-cityDialog__formFieldText">{{establishment.name}}</span>
          </mat-option>
        </ng-container>
        <ng-template #establishmentsEmpty>
          <p class="c-cityDialog__text c-cityDialog__text--empty">
            {{'–ó–∞—Ä–∞–∑ –Ω–µ–º–∞—î –∑–∞–∫–ª–∞–¥—ñ–≤ –≤ —Ü—å–æ–º—É –º—ñ—Å—Ç—ñ.' | translate}}üòû
          </p>
        </ng-template>
      </mat-select>
    </mat-form-field>
  </div>
  <ng-container
    *ngIf="orderForm.controls.city.valid && orderForm.controls.establishment.valid; else establishmentNotSelected">
    <ng-container *ngIf="categories.length && establishmentProducts.length; else productsEmpty">
      <div class="c-orderForm__body c-orderForm__body--scroll">
        <p class="c-orderForm__title">{{'–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è' | translate}}</p>
        <ul class="c-orderFormCategories">
          <li class="c-orderFormCategories__item"
              *ngFor="let category of categories"
              [ngClass]="{'active': category.id === currentCategoryId}"
              (click)="changeCategory(category.id)">
            <img [src]="API_URL + category.img" [alt]="getLocalizationCategoriesKey(category.name) | translate"
                 class="c-orderFormCategories__img">
            <span class="c-orderFormCategories__title">
              {{getLocalizationCategoriesKey(category.name) | translate}}
            </span>
          </li>
        </ul>

        <ul class="c-orderFormProduct">
          <li *ngFor="let product of establishmentProducts" class="c-orderFormProduct__item">
            <div class="c-orderFormProduct__info">
              <img [src]="API_URL + product.img" [alt]="product.name" class="c-orderFormProduct__img">
              <div>
                <p class="c-orderFormProduct__name">{{product.name}}</p>
                <p *ngIf="product.capacity" class="c-orderFormProduct__capacity">
                  {{product.capacity.size}}{{product.capacity.unit}}
                </p>
              </div>
              <div class="c-orderFormProduct__prices">
                <p *ngIf="product.price !== product.bonus" class="c-orderFormProduct__price c-orderFormProduct__price--bonus">
                  +{{+product.bonus}}{{'–≥—Ä–Ω' | translate}}
                </p>
                <p class="c-orderFormProduct__price">{{+product.price}}{{'–≥—Ä–Ω' | translate}}</p>
              </div>
            </div>

            <button class="c-orderForm__btn" (click)="openProductPreview(product)" matRipple><mat-icon>add</mat-icon></button>
          </li>
        </ul>
      </div>
    </ng-container>
    <ng-template #productsEmpty>
      <div class="c-orderForm__body">
        <p class="c-orderForm__empty">{{'–¢–æ–≤–∞—Ä–∏ —Å–∫–æ—Ä–æ –∑\'—è–≤–ª—è—Ç—å—Å—è –Ω–∞ –Ω–∞—à—ñ–π –≤—ñ—Ç—Ä–∏–Ω—ñ'  | translate}}üòå</p>
      </div>
    </ng-template>
  </ng-container>
  <ng-template #establishmentNotSelected>
    <div class="c-orderForm__body">
      <p class="c-orderForm__empty">{{'–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ —ñ –∑–∞–∫–ª–∞–¥, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —à–≤–∏–¥–∫–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.'  | translate}}</p>
    </div>
  </ng-template>

  <shopping-cart [isMobile]="true"
                 [network]="network"
                 [pageLoaded]="categoriesWithProductsSub.closed"
                 [currentCartType]="cartType.ProductsTemplate"></shopping-cart>
</form>
