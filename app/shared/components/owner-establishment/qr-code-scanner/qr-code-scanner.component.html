<div class="c-dialog c-dialogScanner"
     [ngClass]="{'c-dialog--small c-dialog--autoHeight': abonementHasAlreadyBeenUsed, 'c-dialog--fullHeight': !abonementHasAlreadyBeenUsed}">

  <ng-container *ngIf="abonementHasAlreadyBeenUsed; else order">
    <div class="c-dialog__header">
      <p class="c-dialog__title">{{'QR-–∫–æ–¥ —Å–∫–∞–Ω–µ—Ä' | translate}}</p>
      <button class="c-dialog__close" matDialogClose>
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="c-dialog__body c-dialog__body--center c-dialog__body--padding">
      <p class="c-dialog__text c-dialog__text--center" style="font-size: 40px;">üßê</p>
      <p class="c-dialog__text c-dialog__text--center c-dialog__text--error">
        {{abonementHasAlreadyBeenUsed | translate}}
      </p>
    </div>
  </ng-container>
  <ng-template #order>

    <ng-container *ngIf="result; else scanner">
      <ng-container *ngIf="getInformation.closed else informationLoading">
        <div class="c-dialog__header">
          <p class="c-dialog__title">{{'QR-–∫–æ–¥ —Å–∫–∞–Ω–µ—Ä' | translate}}</p>
          <button class="c-dialog__close" (click)="closeDialog()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="c-dialog__body c-dialog__body--padding">
          <div *ngIf="!isDialogNotificationHide" class="c-dialogNotification c-dialogNotification--warn">
            <mat-icon class="c-dialogNotification__icon">info</mat-icon>
            <p class="c-dialogNotification__text">
              {{'QrCode —É—Å–ø—ñ—à–Ω–æ —Å–∫–∞–Ω–æ–≤–∞–Ω–∏–π, –ø—ñ—Å–ª—è —Ç–æ–≥–æ —è–∫ –≤–∏–¥–∞—Å—Ç–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–ø–∏—Å–∞—Ç–∏.' | translate}}
            </p>
            <button class="c-dialogNotification__close" (click)="isDialogNotificationHide = !isDialogNotificationHide">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <ng-container *ngIf="user">
            <p class="c-dialog__bodyTitle c-dialog__bodyTitle--small">{{'–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥:'| translate}} {{user.name}}</p>
            <p class="c-dialog__text c-dialog__text--small">{{'Email' | translate}}: {{user.email}}</p>
          </ng-container>
          <div class="c-dialogTable">
            <div class="c-dialogTable__row c-dialogTable__row--head">
              <div class="c-dialogTable__cell c-dialogTable__cell--notPhones">‚Ññ</div>
              <div class="c-dialogTable__cell">{{'–¢–æ–≤–∞—Ä' | translate}}</div>
              <div class="c-dialogTable__cell">{{'–ö—ñ–ª—å–∫—ñ—Å—Ç—å' | translate}}</div>
            </div>
            <div class="c-dialogTable__row" *ngFor="let abonement of usedAbonements; let i = index">
              <div class="c-dialogTable__cell c-dialogTable__cell--notPhones"><span class="mob">‚Ññ:</span> {{i + 1}}
              </div>
              <div class="c-dialogTable__cell"><span class="mob">
                {{'–¢–æ–≤–∞—Ä' | translate}}:</span>
                <div>
                  {{abonement.product_name}}
                  <ul class="c-dialogTable__cellSupplements">
                    <li *ngFor="let option of abonement.supplement_options">
                      {{option.name}}<ng-container *ngIf="option.quantity > 1">({{option.quantity}})</ng-container>,
                    </li>
                  </ul>
                </div>
              </div>
              <div class="c-dialogTable__cell"><span class="mob">{{'–ö—ñ–ª—å–∫—ñ—Å—Ç—å' | translate}}
                :</span> {{abonement.quantity}}{{'—à—Ç' | translate}}</div>
            </div>
          </div>

        </div>
        <div *ngIf="result" class="c-dialog__footer">
          <div class="c-dialog__footerBtns">
            <button *ngIf="abonementHasAlreadyBeenUsed" class="o-button o-button--gray" matRipple matDialogClose>
              {{'–ó–∞–∫—Ä–∏—Ç–∏' | translate}}
            </button>
            <button *ngIf="!abonementHasAlreadyBeenUsed" class="o-button o-button--gray" matRipple
                    (click)="closeDialog()">
              <ng-container *ngIf="deletingOrCodeAbonementsSub.closed; else btnLoading">
                {{'–í—ñ–¥–º—ñ–Ω–∏—Ç–∏' | translate}}
              </ng-container>
            </button>
            <button *ngIf="!abonementHasAlreadyBeenUsed" class="o-button o-button--secondary" matRipple
                    (click)="writeOffAbonements()">
              <ng-container *ngIf="writeOffAbonementsSub.closed; else btnLoading">
                {{'–°–ø–∏—Å–∞—Ç–∏' | translate}}
              </ng-container>
            </button>
          </div>
        </div>
      </ng-container>
      <ng-template #informationLoading>
        <spinner class="c-dialogScanner__spinner"></spinner>
      </ng-template>
    </ng-container>
    <ng-template #scanner>
      <div class="c-dialogScanner__closeBtns">
        <button class="c-dialog__close" matDialogClose>
          <mat-icon>arrow_back</mat-icon>
        </button>
      </div>
      <div class="c-dialog__body c-dialog__body--center c-dialog__body--notPadding">

        <div class="c-dialogScanner__wrapper">
          <ng-container *ngIf="!error; else scanError">
            <p class="c-dialogScanner__text">{{'–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥' | translate}}</p>
            <zxing-scanner
              class="c-dialogScanner__scanner"
              previewFitMode="cover"
              [autofocusEnabled]="true"
              (camerasNotFound)="camerasNotFoundHandler($event)"
              (scanSuccess)="scanSuccessHandler($event)"
              (scanError)="scanErrorHandler($event)"
              (scanFailure)="scanFailureHandler()"
              (scanComplete)="scanCompleteHandler($event)"></zxing-scanner>
            <div *ngIf="isScanLoaded" class="c-dialogScanner__frame">
              <span class="c-dialogScanner__frameBorder topLeft"></span>
              <span class="c-dialogScanner__frameBorder topRight"></span>
              <span class="c-dialogScanner__frameBorder bottomLeft"></span>
              <span class="c-dialogScanner__frameBorder bottomRight"></span>
              <p class="c-dialogScanner__frameText">QR-Code</p>
            </div>
          </ng-container>
          <ng-template #scanError>
            <p class="c-dialogScanner__error">{{error | translate}}</p>
            <button class="o-button o-button--gray"
                    (click)="scanAgain()">{{'–°–∫–∞–Ω—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑' | translate}}</button>
          </ng-template>
        </div>
      </div>
      <spinner *ngIf="!isScanLoaded && !error" class="c-dialogScanner__spinner"></spinner>
    </ng-template>

  </ng-template>
</div>

<ng-template #btnLoading>
  <spinner class="o-buttonSpinner o-buttonSpinner--white"></spinner>
</ng-template>

<audio hidden #audioOption>
  <source src='/assets/audio/scan.mp3' type="audio/mp3">
</audio>
